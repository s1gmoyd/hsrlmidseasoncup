<html>
  <head>
    <script src="js/WsSubscribers.js"></script>
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/OverlaySystemWsSubscribers.js"></script>
    <link rel="stylesheet" href="css/in-game-eventfeed.css">
  </head>
  <body>
    <div id="eventfeed"></div>

    <script>    
      $(() => {
        //<!--- My RL Overlay Control System --->
        let overlayData;

        OverlayWsSubscribers.init(49321, false);
        OverlayWsSubscribers.subscribe("overlay", "full_update-2021hsmidseason", (data) => {
          overlayData = data;
              $(':root').css("--blueHomePrimaryColor", data["blueUniversity"]["color_home_primary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_home_primary"]}` : "#0051ff");
              $(':root').css("--blueHomeSecondaryColor", data["blueUniversity"]["color_home_secondary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_home_secondary"]}` : "#0051ff");
              $(':root').css("--blueAwayPrimaryColor", data["blueUniversity"]["color_away_primary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_away_primary"]}` : "#0051ff");
              $(':root').css("--blueAwaySecondaryColor", data["blueUniversity"]["color_away_secondary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_away_secondary"]}` : "#0051ff");
              $(':root').css("--blueAlternatePrimaryColor", data["blueUniversity"]["color_alternate_primary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_alternate_primary"]}` : "#0051ff");
              $(':root').css("--blueAlternateSecondaryColor", data["blueUniversity"]["color_alternate_secondary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_alternate_secondary"]}` : "#0051ff");
              $(':root').css("--orangeHomePrimaryColor", data["orangeUniversity"]["color_home_primary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_home_primary"]}` : "#ffaa00");
              $(':root').css("--orangeHomeSecondaryColor", data["orangeUniversity"]["color_home_secondary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_home_secondary"]}` : "#ffaa00");
              $(':root').css("--orangeAwayPrimaryColor", data["orangeUniversity"]["color_away_primary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_away_primary"]}` : "#ffaa00");
              $(':root').css("--orangeAwaySecondaryColor", data["orangeUniversity"]["color_away_secondary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_away_secondary"]}` : "#ffaa00");
              $(':root').css("--orangeAlternatePrimaryColor", data["orangeUniversity"]["color_alternate_primary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_alternate_primary"]}` : "#ffaa00");
              $(':root').css("--orangeAlternateSecondaryColor", data["orangeUniversity"]["color_alternate_secondary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_alternate_secondary"]}` : "#ffaa00");

              //Transparent versions
              $(':root').css("--blueHomePrimaryColorTrans", data["blueUniversity"]["color_home_primary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_home_primary"]}00` : "#0051ff00");
              $(':root').css("--blueHomeSecondaryColorTrans", data["blueUniversity"]["color_home_secondary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_home_secondary"]}00` : "#0051ff00");
              $(':root').css("--blueAwayPrimaryColorTrans", data["blueUniversity"]["color_away_primary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_away_primary"]}00` : "#0051ffe6");
              $(':root').css("--blueAwaySecondaryColorTrans", data["blueUniversity"]["color_away_secondary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_away_secondary"]}00` : "#0051ff00");
              $(':root').css("--blueAlternatePrimaryColorTrans", data["blueUniversity"]["color_alternate_primary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_alternate_primary"]}00` : "#0051ff00");
              $(':root').css("--blueAlternateSecondaryColorTrans", data["blueUniversity"]["color_alternate_secondary"] !== "" && data["blueTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["blueUniversity"]["color_alternate_secondary"]}00` : "#0051ff00");
              $(':root').css("--orangeHomePrimaryColorTrans", data["orangeUniversity"]["color_home_primary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_home_primary"]}00` : "#ffaa0000");
              $(':root').css("--orangeHomeSecondaryColorTrans", data["orangeUniversity"]["color_home_secondary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_home_secondary"]}00` : "#ffaa0000");
              $(':root').css("--orangeAwayPrimaryColorTrans", data["orangeUniversity"]["color_away_primary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_away_primary"]}00` : "#ffaa0000");
              $(':root').css("--orangeAwaySecondaryColorTrans", data["orangeUniversity"]["color_away_secondary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_away_secondary"]}00` : "#ffaa0000");
              $(':root').css("--orangeAlternatePrimaryColorTrans", data["orangeUniversity"]["color_alternate_primary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_alternate_primary"]}00` : "#ffaa0000");
              $(':root').css("--orangeAlternateSecondaryColorTrans", data["orangeUniversity"]["color_alternate_secondary"] !== "" && data["orangeTeamAdvancedSettings"]["useDefaultColors"] === false ? `#${data["orangeUniversity"]["color_alternate_secondary"]}00` : "#ffaa0000");
        });

        //<!--- SOS Overlay Control System --->
        let eventIconLookup = {
          "Win": "icons/stat-icons/win.svg",
          "MVP": "icons/stat-icons/mvp.svg",
          "Goal": "icons/stat-icons/goal.svg",
          "Aerial Goal": "icons/stat-icons/aerial-goal.svg",
          "Backwards Goal": "icons/stat-icons/backwards-goal.svg",
          "Bicycle Goal": "icons/stat-icons/bicycle-hit.svg",
          "Long Goal": "icons/stat-icons/long-goal.svg",
          "Overtime Goal": "icons/stat-icons/overtime-goal.svg",
          "Hat Trick": "icons/stat-icons/hat-trick.svg",
          "Turtle Goal": "icons/stat-icons/turtle-goal.svg",
          "Assist": "icons/stat-icons/assist.svg",
          "Playmaker": "icons/stat-icons/playmaker.svg",
          "Save": "icons/stat-icons/save.svg",
          "Epic Save": "icons/stat-icons/epic-save.svg",
          "Savior": "icons/stat-icons/savior.svg",
          "Shot on Goal": "icons/stat-icons/shot-on-goal.svg",
          "Center Ball": "icons/stat-icons/center-ball.svg",
          "Clear Ball": "icons/stat-icons/clear-ball.svg",
          "Aerial Hit": "icons/stat-icons/aerial-hit.svg",
          "Bicycle Hit": "icons/stat-icons/bicycle-hit.svg",
          "Juggle": "icons/stat-icons/juggle.svg",
          "Demolition": "icons/stat-icons/demolition.svg",
          "Extermination": "icons/stat-icons/extermination.svg",
          "First Touch": "icons/stat-icons/first-touch.svg",
          "Pool Shot": "icons/stat-icons/pool-shot.svg",
          "Low Five": "icons/stat-icons/low-five.svg",
          "High Five": "icons/stat-icons/high-five.svg",
          "Damage": "icons/stat-icons/damage.svg",
          "Ultra Damage": "icons/stat-icons/ultra-damage.svg",
          "Swish Goal": "icons/stat-icons/swish-goal.svg" 
        };
        
        let eventId = 0;
        let players = {};

        function WhiteOrBlack(bgColor) {
          let r = parseInt(bgColor.substring(0, 2), 16);
          let g = parseInt(bgColor.substring(2, 4), 16);
          let b = parseInt(bgColor.substring(4, 6), 16);
          let uicolors = [r / 255.0, g / 255.0, b / 255.0];
          let c = uicolors.map((col) => {
            if (col <= 0.03928) {
              return col / 12.92;
            }
            return Math.pow((col + 0.055) / 1.055, 2.4);
          });
          let L = (0.2126 * c[0]) + (0.7152 * c[1]) + (0.0722 * c[2]);
          return (L > 0.179);
        }

        WsSubscribers.init(49322, false);
        WsSubscribers.subscribe("game", "statfeed_event", (d) => {
          let leftTeamColor = players[d['main_target']['id']]['team'] === 0 ? "blue" : "orange";
          let rightTeamColor = d['secondary_target']['id'] !== "" ? (players[d['secondary_target']['id']]['team'] === 0 ? "blue" : "orange") : "";
          let leftSetup;
          let leftTextColor;
          let rightSetup;
          let rightTextColor;

          if (overlayData[`${leftTeamColor}TeamAdvancedSettings`]["useHome"]) {
            leftSetup = "home";
            leftTextColor = WhiteOrBlack(overlayData[`${leftTeamColor}TeamAdvancedSettings`]["useDefaultColors"] === false ? `${overlayData[`${leftTeamColor}University`]["color_home_primary"]}` : "0051ff") ? "black" : "white";
          } else if (overlayData[`${leftTeamColor}TeamAdvancedSettings`]["useAway"]) {
            leftSetup = "away";
            leftTextColor = WhiteOrBlack(overlayData[`${leftTeamColor}TeamAdvancedSettings`]["useDefaultColors"] === false ? `${overlayData[`${leftTeamColor}University`]["color_away_primary"]}` : "0051ff") ? "black" : "white";
          } else if (overlayData[`${leftTeamColor}TeamAdvancedSettings`]["useAlternate"]) {
            leftSetup = "alternate";
            leftTextColor = WhiteOrBlack(overlayData[`${leftTeamColor}TeamAdvancedSettings`]["useDefaultColors"] === false ? `${overlayData[`${leftTeamColor}University`]["color_alternate_primary"]}` : "0051ff") ? "black" : "white";
          }

          if (rightTeamColor === "blue" || rightTeamColor === "orange") {
            if (overlayData[`${rightTeamColor}TeamAdvancedSettings`]["useHome"]) {
              rightSetup = "home";
              rightTextColor = WhiteOrBlack(overlayData[`${rightTeamColor}TeamAdvancedSettings`]["useDefaultColors"] === false ? `${overlayData[`${rightTeamColor}University`]["color_home_primary"]}` : "0051ff") ? "black" : "white";
            } else if (overlayData[`${rightTeamColor}TeamAdvancedSettings`]["useAway"]) {
              rightSetup = "away";
              rightTextColor = WhiteOrBlack(overlayData[`${rightTeamColor}TeamAdvancedSettings`]["useDefaultColors"] === false ? `${overlayData[`${rightTeamColor}University`]["color_away_primary"]}` : "0051ff") ? "black" : "white";
            } else if (overlayData[`${rightTeamColor}TeamAdvancedSettings`]["useAlternate"]) {
              rightSetup = "alternate";
              rightTextColor = WhiteOrBlack(overlayData[`${rightTeamColor}TeamAdvancedSettings`]["useDefaultColors"] === false ? `${overlayData[`${rightTeamColor}University`]["color_alternate_primary"]}` : "0051ff") ? "black" : "white";
            }
          }

          let homeHtml = `
            <div class="left ${leftTeamColor} ${leftSetup} ${leftTextColor}">
              ${d['main_target']['name']}
            </div>
          `;
          
          let eventIconHtml = `
            <div class="icon">
              <img src=${eventIconLookup[d["type"]] || ""}></img>
            </div>
          `;
          
          let awayHtml = `
            ${d['secondary_target']['id'] !== "" ?
            `<div class='right ${rightTeamColor} ${rightSetup} ${rightTextColor}'>
              ${d['secondary_target']['name']}
            </div>`
            : ""}
          `;

          let eventIdName = "event-" + eventId;

          let eventHtml = `
            <div class="event" id="${eventIdName}">
              ${homeHtml + eventIconHtml + awayHtml}
            </div>
          `;

          $("#eventfeed").append(eventHtml)
          setTimeout(function() {
            $(`#${eventIdName}`).remove();
          }, 4000)
          
          eventId++;
        })
        
        WsSubscribers.subscribe("game", "update_state", (d) => {
          players = d['players'];
        })
      });
    </script>
  </body>
</html>